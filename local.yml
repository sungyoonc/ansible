---
- hosts: localhost
  vars:
    sshkey: ".ssh/ansible_ed25519"
  pre_tasks:
    - name: pre-run | Create temporary file
      ansible.builtin.tempfile:
        state: file
        suffix: temp
      register: tempfile_ssh
      changed_when: false
      tags:
        - never
        - install
        - dotfiles
    - name: pre-run | Temporarily install SSH key to tmp directory
      ansible.builtin.copy:
        src: "{{ sshkey }}"
        dest: "{{ tempfile_ssh.path }}"
        mode: 0600
      changed_when: false
      tags:
        - never
        - install
        - dotfiles
  tasks:
    - block:
        - import_tasks: tasks/core.yml
        - import_tasks: tasks/zsh.yml
        - import_tasks: tasks/dotfiles.yml
        - import_tasks: tasks/tools.yml
      tags:
        - never
      rescue:
        - name: error | Print when errors
          ansible.builtin.debug:
            msg: Encountered an error!
          changed_when: false
          tags: always
      always:
        - name: cleanup | Remove all temporary files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          with_fileglob:
          - "/tmp/ansible.*temp"
          changed_when: false
          tags: always
